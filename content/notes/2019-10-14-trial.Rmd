---
title: Schengen visas statistics around the world in 2018
output:
  html_document:
    number_sections: TRUE
    toc: TRUE
    code_folding: show
    theme: readable
    highlight: tango
---


# Introduction


We are analyzing here the statistics of visas delivered by Schengen countries around the world. We will use two datasets, available on [kaggle](https://www.kaggle.com): one lists visa statistics of Schengen countries consulates around the world in 2017 and 2018 ([Schengen visas dataset](https://www.kaggle.com/ma7555/schengen-visa-stats)) and the other one contains [world population data](https://www.kaggle.com/theworldbank/world-bank-population-estimates-and-ranking). I published this analysis as a [notebook](https://www.kaggle.com/lamiaz/schengen-visas-geopolitics-revealed) on kaggle as well, so
if you want to see the R code to perform the analysis, you can find it there.

A Schengen visa allows a traveller to enter into the Schengen Area, which comprises the following 25 countries:
Austria, Belgium, the Czech Republic, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Iceland, Italy, Latvia, Lithuania, Luxembourg, Malta, the Netherlands, Norway, Poland, Portugal, Slovakia, Slovenia, Spain, Sweden and Switzerland.


```{r, message=FALSE, warning=FALSE, echo = FALSE}
## Loading libraries
## Needed for data analysis and plotting:
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(rworldmap)
## Needed for plot formatting, to be able to read all labels:
library(ggrepel)
## Needed for table formatting:
library(knitr)
library(kableExtra)

## Creating world map (without Antarctica) and defining Schengen countries
schengen = str_to_upper(c("Austria","Belgium","Czech Republic","Denmark","Estonia","Finland","France","Germany","Greece","Hungary","Iceland","Italy","Latvia","Lithuania","Luxembourg","Malta","Netherlands","Norway","Poland","Portugal","Slovakia","Slovenia","Spain","Sweden","Switzerland"))
map_world = map_data(map = "world",region = "(?!Antarctica)") %>%
mutate(region = str_to_upper(region))
map_world$schengen = as.numeric(map_world$region %in% schengen)

## Some countries have a different name in world map dataset and in the visas dataset so we change these
map_world = map_world %>%
    mutate(region = recode(region,
			`DEMOCRATIC REPUBLIC OF THE CONGO` = "CONGO (DEMOCRATIC REPUBLIC)",
			`REPUBLIC OF CONGO` = "CONGO (BRAZZAVILLE)",
			`PALESTINE` = "PALESTINIAN AUTHORITY",
			`RUSSIA` = "RUSSIAN FEDERATION",
		        `IVORY COAST` = "COTE D'IVOIRE",
			`UK` = "UNITED KINGDOM",
			`MACEDONIA` = "NORTH MACEDONIA",
			`TRINIDAD` = "TRINIDAD AND TOBAGO",
			`TOBAGO` = "TRINIDAD AND TOBAGO"))
```


```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
ggplot() +
    geom_map(data = map_world, map = map_world, aes(map_id = region, fill = schengen)) +
    expand_limits(x = map_world$long, y = map_world$lat) +
    theme(legend.position="none") +
    xlab("Longitude") +
    ylab("Latitude") +
    ggtitle("Schengen countries")
```


People holding certain citizenships don't need a Schengen visa to enter the Schengen area, their passport is enough. But most citizenships do.
There are different types of Schengen visas.
A uniform visa allows one to enter the Schengen area and stay there for a short time (up to 90 days). Uniform visas can either allow for a single entry or for multiple entries within the visa's validity period. A consulate can also issue a visa that only allows its holder to be in the country that issued the visa to the exclusion of any other Schengen country (visa with limited territorial validity).

If a person needs to transit through an airport in the Schengen area before continuing their journey to a destination outside the Schengen area, they will need an airport transit visa (ATV).

We will look at statistics of visa issuance and refusal across Schengen states and countries asking for visas. We will also look at the distribution of consulates around the world, and how they can be indicators of geopolitical significance.


```{r, echo = FALSE}

## Reading Schengen visas dataset for 2018
visas2018 = read.csv("2018-data-for-consulates.csv",h=T,stringsAsFactors=F,na.strings="")

## Function convert_rate to convert character rates with "%" sign to numerical value
convert_rate = function(x)
{
    return(as.numeric(str_replace(x,"%",""))/100)
}

## Function convert_numeric to convert character numbers with possible comma separators to numeric
convert_numeric = function(x)
{
    return(as.numeric(str_replace(x,",","")))
}

## Define the columns to convert to numerical
col_rate = str_subset(names(visas2018),regex("rate|share",ignore_case=T))
col_numeric =
names(visas2018)[!str_detect(names(visas2018),regex("rate|share",ignore_case=T)) & str_detect(names(visas2018),regex("atv|uniform|ltv",ignore_case=T))]


## Remove the rows where Schenge.State is NA. Some are completely uninformative and others don't follow the column format with words instead of numbers and totals
visas2018 = visas2018 %>% filter(!is.na(Schengen.State))


## Convert columns to numerical
visas2018 = visas2018 %>%
mutate_at(col_rate,convert_rate) %>%
mutate_at(col_numeric,convert_numeric)

## Reading World population data and only keeping year 2018
worldpop = read.csv("Population-EstimatesData.csv", stringsAsFactors=F,h=T,na.strings="")

worldpop = worldpop %>%
    filter(Indicator.Name == "Population, total") %>%
    select(Country = Country.Name,Population2018 = X2018) %>%
    mutate(Country = str_to_upper(Country))

## Some countries have a different name in the two datasets, so we modify these
worldpop = worldpop %>%
    mutate(Country = recode(Country, `UNITED STATES` = "USA",
                            `EGYPT, ARAB REP.` = "EGYPT",
                            `SLOVAK REPUBLIC` = "SLOVAKIA",
                            `KOREA, DEM. PEOPLE’S REP.` = "NORTH KOREA",
                            `KOREA, REP.` = "SOUTH KOREA",
                            `VENEZUELA, RB` = "VENEZUELA",
                            `ST. LUCIA` = "SAINT LUCIA",
                            `CABO VERDE` = "CAPE VERDE",
                            `HONG KONG SAR, CHINA` = "HONG KONG S.A.R.",
                            `CONGO, DEM. REP.` = "CONGO (DEMOCRATIC REPUBLIC)",
                            `CONGO, REP.` = "CONGO (BRAZZAVILLE)",
                            `KYRGYZ REPUBLIC` = "KYRGYZSTAN",
                            `MACAO SAR, CHINA` = "MACAO S.A.R.",
                            `IRAN, ISLAMIC REP.` = "IRAN",
                            `SYRIAN ARAB REPUBLIC` = "SYRIA",
                            `LAO PDR` = "LAOS",
                            `WEST BANK AND GAZA` = "PALESTINIAN AUTHORITY"))

## Join Schengen visas and world population datasets
visas2018 = left_join(visas2018,worldpop,by=c("Country.where.consulate.is.located"="Country"))
```

# Analysis of visa and consular statistics

## Number of visa applications per country

We first look at the number of uniform visa applications per country for the 20 countries that file the highest number of applications.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
     group_by(Country.where.consulate.is.located) %>%
     summarize(sum.Uniform.visas.applied.for = sum(Uniform.visas.applied.for, na.rm=T)) %>%
     right_join(.,map_world, by=c("Country.where.consulate.is.located"="region")) %>%
     ggplot(aes(map_id = Country.where.consulate.is.located)) +
     geom_map(map = map_world,aes(fill = sum.Uniform.visas.applied.for)) +
     expand_limits(x = map_world$long, y = map_world$lat) +
     scale_fill_distiller(palette = "Blues", direction = 1,
     name = "Number of\nvisa applications", trans = "sqrt",
     breaks = c(100000,500000,1000000,2000000),
     labels = c("100.000","500.000","1.000.000","2.000.000")) +
     xlab("Longitude") +
     ylab("Latitude") +
     ggtitle("Total number of visa applications")
```

Russia is number one with around 3.7 million visa applications in 2018. It is followed by China (2.8 million) and India (1.1 million). In the top 10, we also find smaller countries such as Algeria, Belarus and Morocco, with around 0.7 million each.
We expect countries with a large population size to ask for more visas than countries with a smaller population. In order to take out this effect, we redo the same analysis, this time normalizing by population size and calculating the number of visa applications per 100.000 people.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    filter(!is.na(Population2018) & !is.na(Uniform.visas.applied.for)) %>%
    group_by(Country.where.consulate.is.located) %>%
    summarize(Uniform.applications.per.100000.person = 100000*sum(Uniform.visas.applied.for)/unique(Population2018)) %>%
    right_join(.,map_world, by=c("Country.where.consulate.is.located"="region")) %>%
     ggplot(aes(map_id = Country.where.consulate.is.located)) +
     geom_map(map = map_world,aes(fill = Uniform.applications.per.100000.person)) +
     expand_limits(x = map_world$long, y = map_world$lat) +
     scale_fill_distiller(palette = "Oranges", direction = 1,
     name = "Number of visa\napplications per\n100.000 people",
     breaks = c(1000,2000,4000,6000),
     labels = c("1000","2000","4000","6000")) +
     xlab("Longitude") +
     ylab("Latitude") +
     ggtitle("Number of visa applications")

```

After taking into account population size, the picture changes. Belarus which was already the fourth country that asked for the most visas, is now the first once we normalize by its population. Small countries like Kosovo, Koweit or Cape verde now also have some of the highest rate of visa applications per 100.000 people. In order to have a better look at them, we can list the 20 countries with the highest rate of visa applications per person.


```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    filter(!is.na(Population2018) & !is.na(Uniform.visas.applied.for)) %>%
    group_by(Country.where.consulate.is.located) %>%
    summarize(Uniform.applications.per.100000.person = 100000*sum(Uniform.visas.applied.for)/unique(Population2018)) %>%
    top_n(20,Uniform.applications.per.100000.person) %>%
 ggplot(aes(reorder(Country.where.consulate.is.located,Uniform.applications.per.100000.person),Uniform.applications.per.100000.person)) +
    geom_point(col = "darkorange3") +
    geom_segment(aes(x = Country.where.consulate.is.located,
                 xend = Country.where.consulate.is.located,
                 y = 0,
                 yend = Uniform.applications.per.100000.person)) +
    coord_flip() +
    xlab("Country") +
    ylab("Number of uniform visa applications per 100.000 people")
```


## Number of consulates per country

Let's first look at the number of Schengen consulates present in countries around the world. The 20 countries with the highest number of consulates are shown in the figure below.
```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    summarise(nb_of_consulates = n()) %>%
    top_n(20,nb_of_consulates) %>%
    ggplot(aes(reorder(Country.where.consulate.is.located,nb_of_consulates),nb_of_consulates)) +
    geom_point(col = "blue") +
    geom_segment(aes(x = Country.where.consulate.is.located,
                 xend = Country.where.consulate.is.located,
                 y = 0,
                 yend = nb_of_consulates)) +
    coord_flip() +
    xlab("Country") +
    ylab("Number of consulates")
```

We look again at the number of Schengen consulates present in a country, but this time normalized by the country's population size. Here we show the countries with the highest number of Schengen consulates per 100.000 people.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    summarise(nb_of_consulates_per100000 = 100000* n()/unique(Population2018)) %>%
    top_n(20,nb_of_consulates_per100000) %>%
    ggplot(aes(reorder(Country.where.consulate.is.located,nb_of_consulates_per100000),nb_of_consulates_per100000)) +
    geom_point(col = "blue") +
    geom_segment(aes(x = Country.where.consulate.is.located,
                 xend = Country.where.consulate.is.located,
                 y = 0,
                 yend = nb_of_consulates_per100000)) +
    coord_flip() +
    xlab("Country") +
    ylab("Number of consulates per 100.000 people")

```
After taking into account population size, european microstates San Marino, Monaco and Andorra are now at the top. These microstates are not technically part of the EU nor the Schengen area, but they have very close relationships with the EU. San Marino and Monaco have an open border with the Schengen area (respectively with Italy and France), which means it is as if they are part of the Schengen area. Andorra doesn't have an open border, but, given that it is not possible to fly into Andorra, only enter through either Spain or France, it is also de facto in the Schengen area.

## Average number of visa applications per consulate

We now look at how the average number of visa applications treated by a consulate varies depending on the country where the consulate is located. Some countries have very busy consulates whereas others have consulates that treat few applications per year.
We show in the figure below the 20 countries with the highest number of visa applications per consulate.


```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
group_by(Country.where.consulate.is.located) %>%
summarize(Average_visa_app_per_consulate = sum(Total.ATVs.and.uniform.visas.applied.for)/n()) %>%
top_n(20,Average_visa_app_per_consulate) %>%
ggplot(aes(reorder(Country.where.consulate.is.located,Average_visa_app_per_consulate),Average_visa_app_per_consulate)) +
    geom_point(col = 4) +
    geom_segment(aes(x = Country.where.consulate.is.located,
                 xend = Country.where.consulate.is.located,
                 y = 0,
                 yend = Average_visa_app_per_consulate)) +
    coord_flip() +
    xlab("Country") +
    ylab("Average number of visa applications per consulate")

```

Among the countries that have the busiest consulates, we find again countries such as Russia, Belarus, China, India, Algeria, Morocco and Turkey, which are the countries who file the most visa applications.

But there are also countries that have many consulates that are not very busy.
We now look at the interplay between the number of Schengen consulates in a country and the average number of visa applications they receive. We choose to only highlight certain countries to make the figure more readable.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
## These are the countries we choose to label on our plot
countries_to_label = c("BELARUS", "ALGERIA", "MOROCCO", "INDIA", "TURKEY", "CHINA", "RUSSIAN FEDERATION", "AUSTRALIA"  , "BRAZIL",   "CANADA" ,  "GERMANY" , "ISRAEL" , "JAPAN"  , "USA")
country_list = sort(unique(visas2018$Country.where.consulate.is.located))
country_label = rep("",length(country_list))
country_label[country_list %in% countries_to_label] = sort(countries_to_label)
group_color = ifelse(country_label == "" ,"grey","black")
group_color[country_label == "USA"] = "red"
## Define alpha=0.5 for grey points to see the density
group_alpha = rep(1,length(country_list))
group_alpha[group_color == "grey"] = 0.5


visas2018 %>%
	group_by(Country = Country.where.consulate.is.located) %>%
	summarize(Average_visa_app_per_consulate = 	sum(Total.ATVs.and.uniform.visas.applied.for,na.rm=T)/n(), Number_of_consulates = n()) %>%
	ggplot(aes(Number_of_consulates, Average_visa_app_per_consulate)) +
	geom_point(col = group_color, alpha = group_alpha) +
	geom_abline(aes(intercept=0,slope=550),col="grey",linetype="dashed") +
	geom_text_repel(aes(Number_of_consulates, Average_visa_app_per_consulate), label = country_label, size=3, box.padding = 0.5) +
    xlab("Number of consulates") +
    ylab("Average number of visa applications per consulate")
```

We find that the number of Schengen consulates in a country depends both on the number of visa applications but also on the geopolitical importance of the country.
Geopolitical influence can make a Schengen state be present in a country or even have several consulates in it, even if each consulate is treating only a few applications.

Countries such as Australia, Brazil, Canada, Germany, Israel and Japan all have a large number of consulates considering the number of applications they receive, as they are influent on the world stage.
The USA, shown in red in the figure, appears as a clear outlier here, a sure sign of its geopolitical importance!

## Number of Schengen states with a consulate in the country

Another way to look at it is to find out how many out of the 25 Schengen states have a consular presence in a given country. We expect once again that both the number of visa applications and the geopolitical influence will play a role.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
nb_of_states = visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    summarise(nb_of_states = n_distinct(Schengen.State)) %>%
    mutate(nb_of_states_cat = case_when(nb_of_states>20 ~ "21-25", nb_of_states<=20 & nb_of_states>15 ~ "16-20", nb_of_states<=15 & nb_of_states>10 ~ "11-15", nb_of_states<=10 & nb_of_states>5 ~ "6-10", nb_of_states<=5 ~ "1-5"))

nb_of_states %>%
    right_join(.,map_world, by=c("Country.where.consulate.is.located"="region")) %>%
     ggplot(aes(map_id = Country.where.consulate.is.located)) +
     geom_map(map = map_world,aes(fill = factor(nb_of_states_cat,levels=c("1-5","6-10","11-15","16-20","21-25")))) +
     expand_limits(x = map_world$long, y = map_world$lat) +
     scale_fill_brewer(name = "Number of\nSchengen states",
     palette = "YlGnBu",
     na.translate = F) +
     xlab("Longitude") +
     ylab("Latitude") +
     ggtitle("Number of Schengen states with at least a consulate in the country")

```

There are 11 countries that have more than 20 Schengen states with a consular presence:

Canada, China, Egypt, India, Israel, Japan, the Russian Federation, Turkey, Ukraine, the United Kingdom and the USA.

There are 26 countries with 16 to 20 Schengen states with a consular presence:

 Algeria, Argentina, Australia, Bulgaria, Croatia, Cuba, Ethiopia, France, Germany, Indonesia, Iran, Ireland, Kenya, Lebanon, Mexico, Morocco, Nigeria, Pakistan, Romania, Saudi Arabia, Serbia, South Africa, South Korea, Thailand, the United Arab Emirates and Vietnam.

## Schengen states issuing the most visas

Out of all the Schengen states, which ones issue the most visas? And does this depend on the state's population as well, with large states issuing more visas than small ones?

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
group_by(Schengen.State) %>%
summarize(issued = sum(Total..uniform.visas.issued..including.MEV...,na.rm=T)) %>%
ggplot() +
    geom_col(aes(reorder(Schengen.State,issued),issued)) +
    coord_flip() +
    ylab("Number of uniform visas issued") +
    xlab("Schengen state")
```

France appears as a clear number one here, issuing 3.35 million visas in 2018, almost double the second state, Germany, which issued about 1.84 million visas. There is a great disparity in between states with, on the one hand, France, Germany, Italy and Spain largely on top, all issuing more than 1.5 million visas, and, on the other hand, the ten states at the bottom all issuing less than 200.000 visas in 2018.

Let's see now how it varies if we take into account the Schengen state's population size.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
rowwise() %>%
mutate(state.Population2018 = unique(visas2018$Population2018[visas2018$Country.where.consulate.is.located == str_to_upper(Schengen.State)])) %>%
ungroup() %>%
group_by(Schengen.State) %>%
summarize(issued_perperson = sum(Total..uniform.visas.issued..including.MEV...,na.rm=T)/unique(state.Population2018)) %>%
ggplot() +
    geom_col(aes(reorder(Schengen.State,issued_perperson),issued_perperson)) +
    coord_flip() +
    ylab("Number of uniform visas issued / State population size") +
    xlab("Schengen state")
```

When taking into account the state's population size, the top countries become Finland and the three Baltic states (Lithuania, Estonia and Latvia).

## Rate of refused uniform visas

When a person asks for a visa, it is not always accepted. A reason for the refusal is usually communicated to the person, but it can be quite vague. The main reasons usually provided are:

- Not justifying well enough the purpose and condition of your stay
- Not providing a good enough proof of sufficient means
- Being suspected of not intending to return to your home country

The exact criteria behind these categories, and the way one can make sure not to have their application fall into one, is not always entirely clear. Schengen states are afraid of illegal immigration following a legal entry into the Schengen area, and therefore limit visa issuance for the people they deem most at risk of wanting to illegally emigrate. But refusal rate can also depend on political choices made at the level of the Schengen state to limit visa issuance in general, to a particular country, or to a specific category of people. It is hard to tell, as the criteria and politics behind visa issuance are usually not public, leaving one to speculate.

### Rate of refused uniform visas per recipient country

We first look at the refusal rate per recipient country, limiting ourselves to countries that submitted more than 100.000 visa applications in the year.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>=100000) %>%
    summarise(rate_refused = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T)) %>%
    ggplot() +
    geom_col(aes(reorder(Country.where.consulate.is.located,rate_refused),rate_refused)) +
    coord_flip() +
    ylab("Proportion of uniform visa applications refused") +
    xlab("Country of residence")
```

Algeria is the country that has the highest refusal rate of visa applications, with 45.5% of applications being denied!
Four out of the six countries that have the highest refusal rates are in North Africa (Algeria, Egypt, Tunisia and Morocco).

Let's remember the lyrics of Cheb hasni, one of the most popular Algerian raï singers, who says in his song "The visa":

عولت انا نشوف العزيزة"

حرام عليكم

آه غبنتوني

"عكستوهلي حتي في الڤيزا




Which roughly translates to :

"I decided to go see my baby

Shame on you

Ah, you hurt me

You went against me even for the visa"

Being refused a Schengen visa is a central part of life in many countries.


### Rate of refused visas per Schengen state
We can also look at the average rate of refused visas per issuing state, to see if some Schengen states are more prone to accept or refuse visa applications.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    group_by(Schengen.State) %>%
    summarise(rate_refused = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T)) %>%
    ggplot() +
    geom_col(aes(reorder(Schengen.State,rate_refused),rate_refused)) +
    coord_flip() +
    ylab("Proportion of uniform visa applications refused") +
    xlab("Schengen state issuing visas")
```

Malta, Belgium, Portugal and France appear as the states that are the most likely to refuse a visa application. Finland, the three Baltic states and Iceland appear as the states the most likely to accept a visa application.

The drawback of this analysis is that it looks at visa applications in bulk, without differentiating between visa applications emanating from rich and geopolitically influent countries and those emanating from poorer countries. We just saw that the countries with the highest average refusal rates tend to be poorer and/or have less geopolitical clout. Certain Schengen states may receive more applications from countries that tend to get more visa applications refused on average, and this could alter the results we get.

In order to address this issue, we can look at, for each recipient country, how the average refusal rates from all Schengen states compare to the refusal rate by one particular state.
We're going to examine the top 5 countries from the previous figure: Malta, Belgium, Portugal, France and the Netherlands. We will only look at country-state pairs where the country has applied for more than 100 visas in 2018.

First let's look at Malta, Belgium, the Netherlands and Portugal. Each dot represents a country-state pair.

```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.refused.rate = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.refused.rate.state = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T),avg.refused.rate = unique(avg.refused.rate)) %>%
    filter(Schengen.State %in% c("Malta","Belgium","Netherlands","Portugal")) %>%
    ggplot() +
   geom_point(aes(avg.refused.rate,avg.refused.rate.state,colour = Schengen.State),alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_colour_brewer(palette = "Set1", name = "Schengen state") +
    xlim(0,0.6) +
    ylim(0,0.6) +
    xlab("Average refusal rate by all Schengen states") +
    ylab("Average refusal rate by a particular state")
```
Malta, Belgium, the Netherlands and Portugal all appear to tend to refuse visa applications more often than the other states, as we see a clear overrepresentation of dots above the diagonal line.

Let's now look at France, which we saw earlier is the state issuing the highest number of uniform visas.
```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.refused.rate = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.refused.rate.state = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T),avg.refused.rate = unique(avg.refused.rate)) %>%
    filter(Schengen.State == "France") %>%
    ggplot() +
   geom_point(aes(avg.refused.rate,avg.refused.rate.state),colour = "brown",alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    xlim(0,0.6) +
    ylim(0,0.6) +
    xlab("Average refusal rate of countries by all Schengen states") +
    ylab("Average refusal rate of countries by France")
```

France, on the contrary, shows a completely different picture. It doesn't have a higher refusal rate than its neighbouring Schengen states, it is average or even lower for a few countries. The only reason it appears as one of the states with the highest average refusal rates is that it receives more visa applications from countries that get refused more on average.

Let's now look at the countries that had the lowest average refusal rate of visa applications: Finland, Estonia, Lithuania and Latvia. We don't include Iceland as it only has two consulates.

```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.refused.rate = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.refused.rate.state = sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T),avg.refused.rate = unique(avg.refused.rate)) %>%
    filter(Schengen.State %in% c("Finland","Estonia","Lithuania","Latvia")) %>%
    ggplot() +
   geom_point(aes(avg.refused.rate,avg.refused.rate.state,colour = Schengen.State),alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_colour_brewer(palette = "Set1", name = "Schengen state") +
    xlim(0,0.6) +
    ylim(0,0.6) +
    xlab("Average refusal rate by all Schengen states") +
    ylab("Average refusal rate by a particular state")
```

Well, it doesn't seem anymore that Finland and the Baltic states are more accepting than other states! Their rates are more or less on both sides of the diagonal with a few more countries above the diagonal. The reason that they have a higher average acceptance rate is that they tend to receive more applications from countries that tend to get accepted more on average. But in fact they tend to refuse more visa applications than other Schengen states if we look at it for each country.

A reminder that averages can be misleading when they hide a sampling bias !


### Consulates with the worst refusal rates

Which consulates actually have the highest refusal rates?
We only consider consulates that received at least 10 applications in the year.
We rank the 10 consulates with the highest refusal rates in 2018.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
filter(Uniform.visas.applied.for>10) %>%
filter(!is.na(Not.issued.rate.for.uniform.visas)) %>%
select(`Schengen state` = Schengen.State, Country = Country.where.consulate.is.located, Consulate, `Refusal rate` = Not.issued.rate.for.uniform.visas, `Nb applications` = Uniform.visas.applied.for) %>%
arrange(desc(`Refusal rate`)) %>%
slice(1:10) %>%
kable(format = "html") %>%
kable_styling()
```

The worst consulate is that of Malta in Algeria, which refuses 86.8% of applications!

Algeria, Nigeria and the Democratic Republic of Congo all have two consulates each in the list.

## Share of multiple entries visas among uniform visas issued
When a consulate issues a uniform visa, it can give a single entry visa or generously decide to give a multiple entries visa (MEV) that can be reused for subsequent trips within the visa's validity period.
How often do consulates decide to issue multiple entries visa? Does this depend on the Schengen state?

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
## For some reason, there are rows where the number of MEVs issued is higher than the total number of uniform visas issued. As we don't know what is the reason behind this, we exclude these rows by filtering out rows that have a share>1
visas2018 %>%
	filter(Share.of.MEVs.on.total.number.of.uniform.visas.issued<=1) %>%
	group_by(Schengen.State) %>%
	filter(sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)>10) %>%
 	summarize(share.MEV = sum(Multiple.entry.uniform.visas..MEVs..issued, na.rm=T)/sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)) %>%
	ggplot(aes(reorder(Schengen.State,share.MEV),share.MEV)) +
	geom_col() +
 	coord_flip() +
	xlab("Schengen state") +
 	ylab("Share of MEV among Uniform visas issued")
```
There is a very high variability in how likely a Schengen state is to issue a multiple entries visa (MEV). Some countries such as Slovenia, Estonia, the Netherlands and Finland have a very high share of MEVs among the visas issued (higher than 89%). Countries such as France, Malta, Iceland, Sweden, the Czech Republic and Norway have a share in between 21% and 31%. That's quite a large difference!
But as we saw before for the refusal rate, certain Schengen states receive more visa applications from countries that are refused more on average. The same bias could be at play again for the share of MEVs among visas issued.

We are going to look at how the share of MEVs issued by a particular Schengen state relates to the average share of MEVs issued by all states to a particular country, like we did earlier for the refusal rate.

Let's first look at Slovenia, Estonia, the Netherlands and Finland, the four countries that have the highest average share of MEVs.

```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>% filter(sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)>10) %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.share.MEV = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.share.MEV.state = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T),avg.share.MEV = unique(avg.share.MEV)) %>%
    filter(Schengen.State %in% c("Slovenia","Estonia","Netherlands","Finland")) %>%
    ggplot() +
   geom_point(aes(avg.share.MEV,avg.share.MEV.state,colour = Schengen.State),alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_colour_brewer(palette = "Set1", name = "Schengen state") +
    xlab("Average share of MEVs by all Schengen states") +
    ylab("Average share of MEVs by a particular state") +
    xlim(0,1) +
    ylim(0,1)
```

If Slovenia and the Netherlands are clearly above the diagonal line, issuing a higher share of MEVs than other states, Estonia is on both sides and Finland is clearly below the line. Finland is actually less likely to issue a MEV, compared to other states. The only reason its average share of MEVs is high is that it tends to issue more visas to countries that get more MEVs on average.

Let's now look at France, Sweden, the Czech Republic and Norway, some of the countries with the lowest average share of MEVs issued.

```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>%
    filter(sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)>10) %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.share.MEV = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.share.MEV.state = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T),avg.share.MEV = unique(avg.share.MEV)) %>%
    filter(Schengen.State %in% c("France","Sweden","Czech Republic","Norway")) %>%
    ggplot() +
   geom_point(aes(avg.share.MEV,avg.share.MEV.state,colour = Schengen.State),alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_colour_brewer(palette = "Set1", name = "Schengen state") +
    xlab("Average share of MEVs by all Schengen states") +
    ylab("Average share of MEVs by a particular state") +
    xlim(0,1) +
    ylim(0,1)
```

All four countries are clearly below the line, meaning that they are less likely to issue a MEV than other states, and tend to get more visa applications from countries that get a lower share of MEVs. Both factors explain their low average share of MEVs.

Finally, let's look at two interesting states, Spain and Italy.

```{r, out.width='\\textwidth', fig.align='center', warning = FALSE, echo = FALSE}
visas2018 %>%
    filter(sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)>10) %>%
    group_by(Country.where.consulate.is.located) %>%
    mutate(avg.share.MEV = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T)) %>%
    group_by(Country.where.consulate.is.located, Schengen.State) %>%
    filter(sum(Uniform.visas.applied.for,na.rm=T)>100) %>%
    summarize(avg.share.MEV.state = sum(Multiple.entry.uniform.visas..MEVs..issued,na.rm=T)/sum(Total..uniform.visas.issued..including.MEV...,na.rm=T),avg.share.MEV = unique(avg.share.MEV)) %>%
    filter(Schengen.State %in% c("Spain","Italy")) %>%
    ggplot() +
   geom_point(aes(avg.share.MEV,avg.share.MEV.state,colour = Schengen.State),alpha=0.6) +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_colour_brewer(palette = "Set1", name = "Schengen state") +
    xlab("Average share of MEVs by all Schengen states") +
    ylab("Average share of MEVs by a particular state") +
    xlim(0,1) +
    ylim(0,1)
 ```

Spain has a few dots on the diagonal, countries for which its share of MEVs is close to other states, but most dots are very low, below 25%. This probably indicates that Spain has decided on a very low rate of MEVs that it applies indiscriminately in most countries.

Italy is quite different. It has a very high share of MEVs, well above the diagonal line, for countries that tend to get more MEVs on average and it applies a very variable rate of MEVs in other countries. 

Such patterns could indicate that the share of MEVs could be something that is decided at the level of the state through general policies (or quotas) applied in its consulates.

We can also draw histograms, one for each Schengen state, that show the share of multiple entries visas issued among all uniform visas issued. We add a dashed line for the average share.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
	filter(!is.na(Not.issued.rate.for.uniform.visas)) %>%
	filter(Share.of.MEVs.on.total.number.of.uniform.visas.issued<=1) %>%
	group_by(Schengen.State) %>%
	mutate(share.MEV = 	sum(Multiple.entry.uniform.visas..MEVs..issued, na.rm=T)/sum(Total..uniform.visas.issued..including.MEV..., na.rm=T)) %>%
	ggplot(aes(Share.of.MEVs.on.total.number.of.uniform.visas.issued)) +
	geom_histogram(binwidth=0.1) +
	geom_vline(aes(xintercept = share.MEV),linetype = "dashed", col = 4) +
	xlab("Share of MEVs among uniform visas issued") +
	facet_wrap(vars(Schengen.State))
```

 In this figure, we can once again note that Italy, even though it has a somewhat high average share (72%), applies a very different rate in its various consulates, as we can see from the spread distribution of the histogram.

## Relation between visa issuance rate and share of MEVs

Now, we can look at how the share of MEVs among visas issued relates to the general issuance rate.
Do Schengen states that tend to issue a higher proportion of multiple entries visas also tend to have a higher issuance rate in general? If such a correlation exists, it could either be because there are Schengen states that are generally more *generous* or *welcoming*, or just because they are getting more visa applications from richer, more influent countries.
Let's first look at how correlated the two variables are.

```{r, warning = FALSE, message= FALSE, echo = FALSE}
issuance_rate = visas2018 %>%
	filter(Share.of.MEVs.on.total.number.of.uniform.visas.issued<=1) %>%
	group_by(Schengen.State) %>%
 	summarize(share.MEV = 	sum(Multiple.entry.uniform.visas..MEVs..issued, na.rm=T)/sum(Total..uniform.visas.issued..including.MEV..., na.rm=T),
                  uniform.issued = 1-sum(Uniform.visas.not.issued,na.rm=T)/sum(Uniform.visas.applied.for,na.rm=T))

cor.2 = cor.test(issuance_rate$share.MEV,issuance_rate$uniform.issued)
```
We find that the two variables are indeed correlated (with a correlation of 0.42) meaning that the Schengen states that have a higher average issuance rate are also more likely to give multiple entries visas.

We can look at it graphically to have a better idea, by plotting the two variables.

```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
issuance_rate %>%
 	ggplot(aes(uniform.issued,share.MEV,label=Schengen.State)) +
	geom_point(position="jitter") +
	geom_smooth(method="lm") +
	geom_label_repel(size=2) +
 	xlab("Rate of Uniform visas issued") +
   	ylab("Share of MEV among Uniform visas issued") +
	xlim(0.75,1) +
	ylim(0,1)
```

There seems to be a general connection between the two variables. Schengen states which have a higher average issuance rate like Finland, Estonia, Lithuania and Latvia also tend to have a higher average share of MEVs, whereas countries with a lower average issance rate like Malta, France, Portugal or Belgium also tend to have a lower average share of MEVs.

But the relationship doesn't hold for all states, with for example the Netherlands, Slovenia and Germany having an average issuance rate but a high share of MEVs, and Sweden, Norway and the Czech Republic issuing fewer MEVs than other states.
Once again, this means that the policies behind the visa issuance rate and the share of MEVs are different.

## Who asks for airport transit visas and to go where?

Finally, we are going to look at a visa category we haven't considered yet in the analysis, the airport transit visa (ATV) which allows its holder to transit through an airport in the Schengen area without actually entering the country. Which countries ask for the most ATVs?


```{r, out.width='\\textwidth', fig.align='center', echo = FALSE}
visas2018 %>%
    filter(!is.na(Airport.transit.visas..ATVs..applied.for)) %>%
    group_by(Country = Country.where.consulate.is.located) %>%
    summarize(`ATVs applied for` = sum(Airport.transit.visas..ATVs..applied.for), Population = unique(Population2018)) %>%
    arrange(desc(`ATVs applied for`)) %>%
    slice(1:10) %>%
    kable(format = "html") %>%
    kable_styling()

```


By far, the country that asks for the most airport transit visas is Cuba, and it is even more striking given its smaller population size compared to Nigeria or India.
Cubans ask for ATVs to the Netherlands, France and Spain. By looking at the flight statistics out of Havana on [Flightstats](https://www.flightstats.com), we find that the only airlines flying out of Havana to Europe are KLM to Amsterdam, Iberia to Madrid, Air France to Paris and Edelweiss to Zurich. Other airlines fly from Havana to the Caribbean, North America, South America or Russia. The restriction on the flights available from Cuba forces cubans to ask for airport transit visas to Spain, France or the Netherlands if they want to travel to somewhere in Europe outside of the Schengen area, to Africa or to Asia.


# Conclusion
We saw that analyzing a public dataset of Schengen visas statistics can actually teach us a lot about the interplay of visa issuance and geopolitics, as well as help us make guesses regarding the policies that Schengen states adopt in the area. Schengen states have a different presence worldwide, issuing visas to many countries or only to a select few, adjusting their uniform visas issuance rate or more partciularly their multiple entries visas isuance rate according to their own policies. We can only make educated guesses, as, in the end, we don't have access to all the missing data related to visas applications, such as the socio-economic profile of visa applicants. We could only look at data at the scale of countries and consulates. 
I hope you enjoyed this analysis and took away something from it, whether in terms of Schengen policies and visa statistics or drawing figures in R. I sure now have a better understanding of Schengen visas and of how variable their issuance rate can be. It's a good counterpoint to the direct experience many of us have had, asking for Schengen visas and feeling both stressed and a bit lost at how arbitrary the process of acceptance/refusal seemed from afar.